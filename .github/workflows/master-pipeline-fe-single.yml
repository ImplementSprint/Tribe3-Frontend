# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  MASTER PIPELINE ORCHESTRATOR (FRONTEND SINGLE)                â•‘
# â•‘  Branch Strategy: test â†’ uat â†’ main                             â•‘
# â•‘                                                                  â•‘
# â•‘  Single frontend project is expected at repository root (.)       â•‘
# â•‘    VERCEL_PROJECT_ID_FE_SINGLE (repo secret)                     â•‘
# â•‘                                                                  â•‘
# â•‘  Optional repository variables for reuse/customization:          â•‘
# â•‘    FE_SINGLE_SYSTEM_NAME (default: Frontend-Root)               â•‘
# â•‘    FE_SINGLE_WORKING_DIR (default: .)                           â•‘
# â•‘    FE_SINGLE_IMAGE_NAME (default: fe-single-web)                â•‘
# â•‘    FE_SINGLE_VERCEL_PROJECT_SECRET (required, no default)       â•‘
# â•‘    FE_SINGLE_PR_TOKEN_SECRET (default: GH_PR_TOKEN)             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "Master Pipeline Orchestrator â€” FE Single"

on:
  push:
    branches: [test, uat, main]
  pull_request:
    branches: [test, uat, main]

permissions:
  contents: write
  packages: write
  pull-requests: write

# Optional secret for orgs that block GITHUB_TOKEN PR creation:
# GH_PR_TOKEN (preferred) or GHPR_TOKEN (legacy)

concurrency:
  group: master-pipeline-fe-single-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: "Detect Changed Files"
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - '**'
            shared:
              - '.github/**'
              - 'package.json'
              - 'sonar-project.properties'

  frontend:
    name: "${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }} Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ vars.FE_SINGLE_WORKING_DIR != '' && vars.FE_SINGLE_WORKING_DIR || '.' }}
      system-name: ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }}
      enable-security-scan: true
    secrets: inherit

  validate-vercel-secret-vars:
    name: "Validate Vercel Secret-Name Variables"
    runs-on: ubuntu-latest
    steps:
      - name: Ensure required vars are set
        env:
          PROJECT_SECRET_VAR: ${{ vars.FE_SINGLE_VERCEL_PROJECT_SECRET }}
        run: |
          if [ -z "${PROJECT_SECRET_VAR}" ]; then
            echo "âŒ Missing required repository variable FE_SINGLE_VERCEL_PROJECT_SECRET."
            echo "Set FE_SINGLE_VERCEL_PROJECT_SECRET to the secret name that stores your Vercel project ID."
            exit 1
          fi

  version-test:
    name: "Version Tag â€” TEST"
    needs: [frontend]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Version Tag
        id: version
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TAG="test-v$(date -u +%Y.%m.%d).${GITHUB_RUN_NUMBER}-${SHORT_SHA}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Tag already exists: ${TAG}"
            exit 0
          fi

          git tag -a "${TAG}" -m "TEST version ${TAG}"
          git push origin "${TAG}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT

  deploy-test:
    name: "TEST â€” ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }}"
    needs: [frontend, validate-vercel-secret-vars]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_SINGLE_WORKING_DIR != '' && vars.FE_SINGLE_WORKING_DIR || '.' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_SINGLE_VERCEL_PROJECT_SECRET] }}

  deploy-uat:
    name: "UAT â€” ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }}"
    needs: [frontend, validate-vercel-secret-vars]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_SINGLE_WORKING_DIR != '' && vars.FE_SINGLE_WORKING_DIR || '.' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_SINGLE_VERCEL_PROJECT_SECRET] }}

  production-gate:
    name: "Production Readiness Gate"
    needs: [frontend]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && github.event_name == 'push' &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    uses: ./.github/workflows/production-gate.yml
    with:
      system-dir: ${{ vars.FE_SINGLE_WORKING_DIR != '' && vars.FE_SINGLE_WORKING_DIR || '.' }}
      app-type: web
    secrets: inherit

  deploy-prod:
    name: "Prod â€” ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }}"
    needs: [production-gate, validate-vercel-secret-vars]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_SINGLE_WORKING_DIR != '' && vars.FE_SINGLE_WORKING_DIR || '.' }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_SINGLE_VERCEL_PROJECT_SECRET] }}

  version-main-release:
    name: "Version Tag â€” MAIN Release"
    needs: [deploy-prod]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && github.event_name == 'push' &&
      (needs.deploy-prod.result == 'success' || needs.deploy-prod.result == 'skipped')
    outputs:
      version_tag: ${{ steps.version.outputs.tag }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Release Tag
        id: version
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TAG="main-v$(date -u +%Y.%m.%d).${GITHUB_RUN_NUMBER}-${SHORT_SHA}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Tag already exists: ${TAG}"
            exit 0
          fi

          git tag -a "${TAG}" -m "MAIN release ${TAG}"
          git push origin "${TAG}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT

  docker-main:
    name: "GHCR â€” ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }}"
    needs: [version-main-release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/docker-build.yml
    with:
      working-directory: ${{ vars.FE_SINGLE_WORKING_DIR != '' && vars.FE_SINGLE_WORKING_DIR || '.' }}
      image-name: ${{ vars.FE_SINGLE_IMAGE_NAME != '' && vars.FE_SINGLE_IMAGE_NAME || 'fe-single-web' }}
      release-tag: ${{ needs.version-main-release.outputs.version_tag }}
      push-image: true
      scan-vulnerabilities: true
    secrets: inherit

  create-pr-to-uat:
    name: "Create PR â†’ UAT"
    needs: [frontend, version-test, deploy-test]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped') &&
      needs.version-test.result == 'success' &&
      (needs.deploy-test.result == 'success' || needs.deploy-test.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Validate PAT for PR creation
        env:
          PR_TOKEN_PRIMARY: ${{ secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] }}
          PR_SECRET_NAME: ${{ vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN' }}
          GH_PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}
          GHPR_TOKEN: ${{ secrets.GHPR_TOKEN }}
        run: |
          if [ -z "${PR_TOKEN_PRIMARY}" ] && [ -z "${GH_PR_TOKEN}" ] && [ -z "${GHPR_TOKEN}" ]; then
            echo "âŒ Missing PAT secret for PR creation."
            echo "Add repository secret named by FE_SINGLE_PR_TOKEN_SECRET (${PR_SECRET_NAME}), or GH_PR_TOKEN/GHPR_TOKEN."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}

      - name: Create PR from test â†’ uat
        env:
          GH_TOKEN: ${{ secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}
        run: |
          EXISTING_PR=$(gh pr list --base uat --head test --state open --json number --jq '.[0].number' 2>/dev/null || true)
          APP_URL="${{ needs.deploy-test.outputs.deployment_url }}"
          VERSION_TAG="${{ needs.version-test.outputs.version_tag }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          PR_BODY=$(cat <<ENDOFBODY
          ## ðŸš€ Promote TEST â†’ UAT

          ### ðŸ“‹ Pre-merge Checklist
          - [ ] Verified ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }} on TEST
          - [ ] Ready for UAT validation

          ### ðŸ”— Vercel TEST Deployment Link
          - ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }}: ${APP_URL:-Not deployed (no changes)}

          ### ðŸ” Details
          - **Source branch:** test
          - **Target branch:** uat
          - **Version tag:** \`${VERSION_TAG}\`
          - **Commit:** \`${SHORT_SHA}\`
          - **Triggered at:** ${TIMESTAMP}
          ENDOFBODY
          )

          if [ -n "$EXISTING_PR" ]; then
            gh pr edit "$EXISTING_PR" --body "$PR_BODY"
            exit 0
          fi

          gh pr create --base uat --head test --title "ðŸš€ Release: Promote TEST â†’ UAT (${SHORT_SHA})" --body "$PR_BODY"

  create-pr-to-main:
    name: "Create PR â†’ Main"
    needs: [frontend, deploy-uat]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped') &&
      (needs.deploy-uat.result == 'success' || needs.deploy-uat.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Validate PAT for PR creation
        env:
          PR_TOKEN_PRIMARY: ${{ secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] }}
          PR_SECRET_NAME: ${{ vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN' }}
          GH_PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}
          GHPR_TOKEN: ${{ secrets.GHPR_TOKEN }}
        run: |
          if [ -z "${PR_TOKEN_PRIMARY}" ] && [ -z "${GH_PR_TOKEN}" ] && [ -z "${GHPR_TOKEN}" ]; then
            echo "âŒ Missing PAT secret for PR creation."
            echo "Add repository secret named by FE_SINGLE_PR_TOKEN_SECRET (${PR_SECRET_NAME}), or GH_PR_TOKEN/GHPR_TOKEN."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}

      - name: Create PR from uat â†’ main
        env:
          GH_TOKEN: ${{ secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_SINGLE_PR_TOKEN_SECRET != '' && vars.FE_SINGLE_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}
        run: |
          EXISTING_PR=$(gh pr list --base main --head uat --state open --json number --jq '.[0].number' 2>/dev/null || true)
          APP_URL="${{ needs.deploy-uat.outputs.deployment_url }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          PR_BODY=$(cat <<ENDOFBODY
          ## ðŸš€ Promote UAT â†’ Production

          ### ðŸ“‹ Pre-merge Checklist
          - [ ] Verified ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }} on UAT
          - [ ] All acceptance criteria met

          ### ðŸ”— Vercel UAT Deployment Link
          - ${{ vars.FE_SINGLE_SYSTEM_NAME != '' && vars.FE_SINGLE_SYSTEM_NAME || 'Frontend-Root' }}: ${APP_URL:-Not deployed (no changes)}

          ### ðŸ” Details
          - **Source branch:** uat
          - **Target branch:** main
          - **Commit:** \`${SHORT_SHA}\`
          - **Triggered at:** ${TIMESTAMP}
          ENDOFBODY
          )

          if [ -n "$EXISTING_PR" ]; then
            gh pr edit "$EXISTING_PR" --body "$PR_BODY"
            exit 0
          fi

          gh pr create --base main --head uat --title "ðŸš€ Release: Promote UAT â†’ Production (${SHORT_SHA})" --body "$PR_BODY"

  pipeline-summary:
    name: "Pipeline Summary"
    needs: [frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline Results
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Branch:     ${{ github.ref_name }}"
          echo "Frontend:   ${{ needs.frontend.result }}"
