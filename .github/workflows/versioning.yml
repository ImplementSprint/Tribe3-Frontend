name: "Reusable: Versioning"

on:
  workflow_call:
    inputs:
      mode:
        required: true
        type: string
        description: "Versioning mode: test or main"
      stream:
        required: false
        type: string
        default: "global"
        description: "Version stream key (global keeps legacy test-v/main-v tags)"
      update-package-locks:
        required: false
        type: boolean
        default: false
        description: "Refresh npm package-lock.json files and commit before tagging"
      lockfile-node-version:
        required: false
        type: number
        default: 20
        description: "Node.js version used when refreshing package-lock files"
    outputs:
      version_tag:
        description: "Resolved version tag"
        value: ${{ jobs.version.outputs.version_tag }}

permissions:
  contents: write

jobs:
  version:
    name: "Create Version Tag"
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Setup Node.js for lockfile refresh
        if: ${{ inputs.update-package-locks }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.lockfile-node-version }}

      - name: Refresh npm package-lock files
        if: ${{ inputs.update-package-locks }}
        run: |
          set -e

          mapfile -t PACKAGE_JSONS < <(find . -type f -name package.json \
            -not -path "*/node_modules/*" \
            -not -path "*/.next/*" \
            -not -path "*/coverage/*")

          if [ "${#PACKAGE_JSONS[@]}" -eq 0 ]; then
            echo "â„¹ï¸ No package.json files found. Skipping lockfile refresh."
            exit 0
          fi

          for pkg in "${PACKAGE_JSONS[@]}"; do
            dir=$(dirname "$pkg")
            echo "ðŸ”„ Refreshing lockfile in ${dir}"
            (
              cd "$dir"
              npm install --package-lock-only --ignore-scripts
            )
          done

          git add '**/package-lock.json'

          if git diff --cached --quiet; then
            echo "â„¹ï¸ No lockfile changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(lockfiles): refresh package-lock files"
          git push origin "HEAD:${GITHUB_REF_NAME}"

      - name: Create and Push Tag
        id: version
        env:
          MODE: ${{ inputs.mode }}
          STREAM: ${{ inputs.stream }}
        run: |
          STREAM_KEY=$(echo "${STREAM}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')
          if [ -z "${STREAM_KEY}" ]; then
            STREAM_KEY="global"
          fi

          if [ "${STREAM_KEY}" = "global" ]; then
            TEST_PREFIX="test-v"
            MAIN_PREFIX="main-v"
          else
            TEST_PREFIX="test-${STREAM_KEY}-v"
            MAIN_PREFIX="main-${STREAM_KEY}-v"
          fi

          if [ "${MODE}" = "test" ]; then
            PREFIX="${TEST_PREFIX}"
            LATEST=$(git tag -l "${PREFIX}*" | grep -E "^${PREFIX}[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n 1)

            if [ -z "${LATEST}" ]; then
              NEXT_VERSION="1.0.0.0"
            else
              RAW_VERSION="${LATEST#${PREFIX}}"
              IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "${RAW_VERSION}"

              BUILD=$((BUILD + 1))
              if [ "${BUILD}" -ge 10 ]; then
                BUILD=0
                PATCH=$((PATCH + 1))
              fi

              if [ "${PATCH}" -ge 10 ]; then
                PATCH=0
                MINOR=$((MINOR + 1))
              fi

              if [ "${MINOR}" -ge 10 ]; then
                MINOR=0
                MAJOR=$((MAJOR + 1))
              fi

              NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}.${BUILD}"
            fi

            TAG="${PREFIX}${NEXT_VERSION}"
          elif [ "${MODE}" = "main" ]; then
            LATEST_TEST=$(git tag -l "${TEST_PREFIX}*" | grep -E "^${TEST_PREFIX}[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n 1)
            if [ -z "${LATEST_TEST}" ]; then
              echo "âŒ No test version tag found for stream '${STREAM_KEY}'. main release tag requires a prior test tag."
              exit 1
            fi

            VERSION_FROM_TEST="${LATEST_TEST#${TEST_PREFIX}}"
            TAG="${MAIN_PREFIX}${VERSION_FROM_TEST}"
          else
            echo "âŒ Invalid mode: ${MODE}. Expected test or main."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Tag already exists: ${TAG}"
            exit 0
          fi

          if [ "${MODE}" = "test" ]; then
            git tag -a "${TAG}" -m "TEST version ${TAG}"
          else
            git tag -a "${TAG}" -m "MAIN release ${TAG}"
          fi

          git push origin "${TAG}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
