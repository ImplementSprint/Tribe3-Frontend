name: "Reusable: Promotion"

on:
  workflow_call:
    inputs:
      pipeline-kind:
        required: true
        type: string
        description: "single or multi"
      direction:
        required: true
        type: string
        description: "Promotion direction: test-to-uat or uat-to-main"
      system1-name:
        required: false
        type: string
        default: "Frontend-Root"
      system1-url:
        required: false
        type: string
        default: ""
      system2-name:
        required: false
        type: string
        default: ""
      system2-url:
        required: false
        type: string
        default: ""
      system3-name:
        required: false
        type: string
        default: ""
      system3-url:
        required: false
        type: string
        default: ""
      version-tag:
        required: false
        type: string
        default: ""
      dry-run:
        required: false
        type: boolean
        default: false
      system1-result:
        required: false
        type: string
        default: ""
      system2-result:
        required: false
        type: string
        default: ""
      system3-result:
        required: false
        type: string
        default: ""
    secrets:
      PR_TOKEN:
        required: true

jobs:
  promote:
    name: "Create Promotion PR"
    runs-on: ubuntu-latest
    steps:
      - name: Validate PAT for PR creation
        env:
          PR_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          if [ -z "${PR_TOKEN}" ]; then
            echo "âŒ Missing PAT secret for PR creation."
            echo "Provide PR_TOKEN when calling this workflow."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PR_TOKEN }}

      - name: Create promotion PR
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
          PIPELINE_KIND: ${{ inputs.pipeline-kind }}
          DIRECTION: ${{ inputs.direction }}
          SYSTEM1_NAME: ${{ inputs.system1-name }}
          SYSTEM1_URL: ${{ inputs.system1-url }}
          SYSTEM2_NAME: ${{ inputs.system2-name }}
          SYSTEM2_URL: ${{ inputs.system2-url }}
          SYSTEM3_NAME: ${{ inputs.system3-name }}
          SYSTEM3_URL: ${{ inputs.system3-url }}
          SYSTEM1_RESULT: ${{ inputs.system1-result }}
          SYSTEM2_RESULT: ${{ inputs.system2-result }}
          SYSTEM3_RESULT: ${{ inputs.system3-result }}
          VERSION_TAG_INPUT: ${{ inputs.version-tag }}
          DRY_RUN: ${{ inputs.dry-run }}
        run: |
          retry() {
            local attempts=$1
            local delay=$2
            shift 2
            local count=1
            until "$@"; do
              if [ "$count" -ge "$attempts" ]; then
                return 1
              fi
              sleep "$delay"
              count=$((count + 1))
            done
          }

          SHORT_SHA="${GITHUB_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          if [ "${DIRECTION}" = "test-to-uat" ]; then
            SOURCE_BRANCH="test"
            TARGET_BRANCH="uat"
            TITLE="ðŸš€ Release: Promote TEST â†’ UAT (${SHORT_SHA})"
            HEADER="## ðŸš€ Promote TEST â†’ UAT"
            CONTEXT_LABEL="TEST"
            FOOTER="*Merge this PR to trigger UAT deployment.*"
            INTRO="This PR was **automatically created** after all CI checks and TEST deployments passed on the \`test\` branch."

            VERSION_TAG="${VERSION_TAG_INPUT}"
            if [ -z "${VERSION_TAG}" ] || [ "${VERSION_TAG}" = "test-v" ]; then
              VERSION_TAG=$(git tag -l 'test-v*' | grep -E '^test-v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            fi
            if [ -z "${VERSION_TAG}" ]; then
              echo "âŒ Unable to resolve TEST version tag for PR body."
              exit 1
            fi
          elif [ "${DIRECTION}" = "uat-to-main" ]; then
            SOURCE_BRANCH="uat"
            TARGET_BRANCH="main"
            TITLE="ðŸš€ Release: Promote UAT â†’ Production (${SHORT_SHA})"
            HEADER="## ðŸš€ Promote UAT â†’ Production"
            CONTEXT_LABEL="UAT"
            FOOTER="*Merge this PR to deploy to production. A production readiness gate will run automatically.*"
            INTRO="This PR was **automatically created** after all CI checks and UAT deployments passed on the \`uat\` branch."
          else
            echo "âŒ Invalid direction: ${DIRECTION}. Expected test-to-uat or uat-to-main."
            exit 1
          fi

          COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/${TARGET_BRANCH}...${SOURCE_BRANCH}"

          EXISTING_PR=$(gh pr list --base "${TARGET_BRANCH}" --head "${SOURCE_BRANCH}" --state open --json number --jq '.[0].number' 2>/dev/null || true)

          CHECKLIST="- [ ] Verified ${SYSTEM1_NAME} on ${CONTEXT_LABEL}"
          ROWS="| ${SYSTEM1_NAME} | ${SYSTEM1_URL:-Not deployed (no changes)} |"

          if [ -n "${SYSTEM2_NAME}" ]; then
            CHECKLIST="${CHECKLIST}\n- [ ] Verified ${SYSTEM2_NAME} on ${CONTEXT_LABEL}"
            ROWS="${ROWS}\n| ${SYSTEM2_NAME} | ${SYSTEM2_URL:-Not deployed (no changes)} |"
          fi

          if [ -n "${SYSTEM3_NAME}" ]; then
            CHECKLIST="${CHECKLIST}\n- [ ] Verified ${SYSTEM3_NAME} on ${CONTEXT_LABEL}"
            ROWS="${ROWS}\n| ${SYSTEM3_NAME} | ${SYSTEM3_URL:-Not deployed (no changes)} |"
          fi

          if [ "${DIRECTION}" = "test-to-uat" ]; then
            CHECKLIST="${CHECKLIST}\n- [ ] Ready for UAT validation"
          else
            CHECKLIST="${CHECKLIST}\n- [ ] All acceptance criteria met"
          fi

          AVAILABLE_LINKS=0
          [ -n "${SYSTEM1_URL}" ] && AVAILABLE_LINKS=$((AVAILABLE_LINKS + 1))
          [ -n "${SYSTEM2_NAME}" ] && [ -n "${SYSTEM2_URL}" ] && AVAILABLE_LINKS=$((AVAILABLE_LINKS + 1))
          [ -n "${SYSTEM3_NAME}" ] && [ -n "${SYSTEM3_URL}" ] && AVAILABLE_LINKS=$((AVAILABLE_LINKS + 1))

          EVIDENCE_ROWS="| CI â€” ${SYSTEM1_NAME} | ${SYSTEM1_RESULT:-unknown} |"
          if [ -n "${SYSTEM2_NAME}" ]; then
            EVIDENCE_ROWS="${EVIDENCE_ROWS}\n| CI â€” ${SYSTEM2_NAME} | ${SYSTEM2_RESULT:-unknown} |"
          fi
          if [ -n "${SYSTEM3_NAME}" ]; then
            EVIDENCE_ROWS="${EVIDENCE_ROWS}\n| CI â€” ${SYSTEM3_NAME} | ${SYSTEM3_RESULT:-unknown} |"
          fi
          EVIDENCE_ROWS="${EVIDENCE_ROWS}\n| Deployment Links | ${AVAILABLE_LINKS} available |"
          if [ "${DIRECTION}" = "test-to-uat" ]; then
            EVIDENCE_ROWS="${EVIDENCE_ROWS}\n| Version Tag | ${VERSION_TAG} |"
          fi

          DETAILS="- **Source branch:** ${SOURCE_BRANCH}\n- **Target branch:** ${TARGET_BRANCH}"
          if [ "${DIRECTION}" = "test-to-uat" ]; then
            DETAILS="${DETAILS}\n- **Version tag:** \`${VERSION_TAG}\`"
          fi
          DETAILS="${DETAILS}\n- **Commit:** \`${SHORT_SHA}\`\n- **Compare:** [View changes](${COMPARE_URL})\n- **Triggered at:** ${TIMESTAMP}\n- **Pipeline run:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          PR_BODY=$(cat <<ENDOFBODY
          ${HEADER}

          ${INTRO}

          ### ðŸ“‹ Pre-merge Checklist
          ${CHECKLIST}

          ### ðŸ”— Vercel ${CONTEXT_LABEL} Deployment Links
          | System | ${CONTEXT_LABEL} Preview Link |
          |--------|------------------|
          ${ROWS}

          ### âœ… Evidence
          | Check | Status |
          |-------|--------|
          ${EVIDENCE_ROWS}

          ### ðŸ” Details
          ${DETAILS}

          ---
          ${FOOTER}
          ENDOFBODY
          )

          if [ "${DRY_RUN}" = "true" ]; then
            echo "ðŸ§ª Dry run enabled. PR body preview:"
            echo "${PR_BODY}"
            exit 0
          fi

          if [ -n "${EXISTING_PR}" ]; then
            retry 3 3 gh pr edit "${EXISTING_PR}" --body "${PR_BODY}"
            echo "âœ… Updated PR #${EXISTING_PR}: ${SOURCE_BRANCH} â†’ ${TARGET_BRANCH}"
            exit 0
          fi

          retry 3 3 gh pr create --base "${TARGET_BRANCH}" --head "${SOURCE_BRANCH}" --title "${TITLE}" --body "${PR_BODY}"
          echo "âœ… Created PR: ${SOURCE_BRANCH} â†’ ${TARGET_BRANCH}"
