name: "Reusable: Promotion"

on:
  workflow_call:
    inputs:
      pipeline-kind:
        required: true
        type: string
        description: "single or multi"
      direction:
        required: true
        type: string
        description: "Promotion direction: test-to-uat or uat-to-main"
      system1-name:
        required: false
        type: string
        default: "Frontend-Root"
      system1-url:
        required: false
        type: string
        default: ""
      system2-name:
        required: false
        type: string
        default: ""
      system2-url:
        required: false
        type: string
        default: ""
      system3-name:
        required: false
        type: string
        default: ""
      system3-url:
        required: false
        type: string
        default: ""
      version-tag:
        required: false
        type: string
        default: ""
      systems-json:
        required: false
        type: string
        default: ""
      deployment-urls-json:
        required: false
        type: string
        default: "{}"
      results-json:
        required: false
        type: string
        default: "{}"
      dry-run:
        required: false
        type: boolean
        default: false
      system1-result:
        required: false
        type: string
        default: ""
      system2-result:
        required: false
        type: string
        default: ""
      system3-result:
        required: false
        type: string
        default: ""
    secrets:
      PR_TOKEN:
        required: true

jobs:
  promote:
    name: "Create Promotion PR"
    runs-on: ubuntu-latest
    steps:
      - name: Validate PAT for PR creation
        env:
          PR_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          if [ -z "${PR_TOKEN}" ]; then
            echo "âŒ Missing PAT secret for PR creation."
            echo "Provide PR_TOKEN when calling this workflow."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PR_TOKEN }}

      - name: Create promotion PR
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
          PIPELINE_KIND: ${{ inputs.pipeline-kind }}
          DIRECTION: ${{ inputs.direction }}
          SYSTEM1_NAME: ${{ inputs.system1-name }}
          SYSTEM1_URL: ${{ inputs.system1-url }}
          SYSTEM2_NAME: ${{ inputs.system2-name }}
          SYSTEM2_URL: ${{ inputs.system2-url }}
          SYSTEM3_NAME: ${{ inputs.system3-name }}
          SYSTEM3_URL: ${{ inputs.system3-url }}
          SYSTEM1_RESULT: ${{ inputs.system1-result }}
          SYSTEM2_RESULT: ${{ inputs.system2-result }}
          SYSTEM3_RESULT: ${{ inputs.system3-result }}
          SYSTEMS_JSON_INPUT: ${{ inputs.systems-json }}
          DEPLOYMENT_URLS_JSON_INPUT: ${{ inputs.deployment-urls-json }}
          RESULTS_JSON_INPUT: ${{ inputs.results-json }}
          VERSION_TAG_INPUT: ${{ inputs.version-tag }}
          DRY_RUN: ${{ inputs.dry-run }}
        run: |
          retry() {
            local attempts=$1
            local delay=$2
            shift 2
            local count=1
            until "$@"; do
              if [ "$count" -ge "$attempts" ]; then
                return 1
              fi
              sleep "$delay"
              count=$((count + 1))
            done
          }

          SHORT_SHA="${GITHUB_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          if [ "${DIRECTION}" = "test-to-uat" ]; then
            SOURCE_BRANCH="test"
            TARGET_BRANCH="uat"
            TITLE="ðŸš€ Release: Promote TEST â†’ UAT (${SHORT_SHA})"
            HEADER="## ðŸš€ Promote TEST â†’ UAT"
            CONTEXT_LABEL="TEST"
            FOOTER="*Merge this PR to trigger UAT deployment.*"
            INTRO="This PR was **automatically created** after all CI checks and TEST deployments passed on the \`test\` branch."

            VERSION_TAG="${VERSION_TAG_INPUT}"
            if [ -z "${VERSION_TAG}" ] || [ "${VERSION_TAG}" = "test-v" ]; then
              VERSION_TAG=$(git tag -l 'test-v*' | grep -E '^test-v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            fi
            if [ -z "${VERSION_TAG}" ]; then
              echo "âŒ Unable to resolve TEST version tag for PR body."
              exit 1
            fi
          elif [ "${DIRECTION}" = "uat-to-main" ]; then
            SOURCE_BRANCH="uat"
            TARGET_BRANCH="main"
            TITLE="ðŸš€ Release: Promote UAT â†’ Production (${SHORT_SHA})"
            HEADER="## ðŸš€ Promote UAT â†’ Production"
            CONTEXT_LABEL="UAT"
            FOOTER="*Merge this PR to deploy to production. A production readiness gate will run automatically.*"
            INTRO="This PR was **automatically created** after all CI checks and UAT deployments passed on the \`uat\` branch."
          else
            echo "âŒ Invalid direction: ${DIRECTION}. Expected test-to-uat or uat-to-main."
            exit 1
          fi

          COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/${TARGET_BRANCH}...${SOURCE_BRANCH}"

          EXISTING_PR=$(gh pr list --base "${TARGET_BRANCH}" --head "${SOURCE_BRANCH}" --state open --json number --jq '.[0].number' 2>/dev/null || true)

          if [ -n "${SYSTEMS_JSON_INPUT}" ]; then
            SYSTEMS_JSON="${SYSTEMS_JSON_INPUT}"
          else
            SYSTEMS_JSON=$(jq -nc \
              --arg n1 "${SYSTEM1_NAME}" \
              --arg n2 "${SYSTEM2_NAME}" \
              --arg n3 "${SYSTEM3_NAME}" \
              '[
                {name:$n1},
                {name:$n2},
                {name:$n3}
              ] | map(select(.name != ""))')
          fi

          if ! echo "${SYSTEMS_JSON}" | jq -e . >/dev/null 2>&1; then
            echo "âŒ Invalid systems-json payload."
            exit 1
          fi

          if [ "$(echo "${SYSTEMS_JSON}" | jq 'length')" -eq 0 ]; then
            echo "âŒ No systems provided for promotion PR body."
            exit 1
          fi

          if [ -n "${DEPLOYMENT_URLS_JSON_INPUT}" ] && echo "${DEPLOYMENT_URLS_JSON_INPUT}" | jq -e . >/dev/null 2>&1; then
            DEPLOYMENT_URLS_JSON="${DEPLOYMENT_URLS_JSON_INPUT}"
          else
            DEPLOYMENT_URLS_JSON=$(jq -nc \
              --arg n1 "${SYSTEM1_NAME}" --arg u1 "${SYSTEM1_URL}" \
              --arg n2 "${SYSTEM2_NAME}" --arg u2 "${SYSTEM2_URL}" \
              --arg n3 "${SYSTEM3_NAME}" --arg u3 "${SYSTEM3_URL}" \
              '{($n1):$u1, ($n2):$u2, ($n3):$u3}')
          fi

          if [ -n "${RESULTS_JSON_INPUT}" ] && echo "${RESULTS_JSON_INPUT}" | jq -e . >/dev/null 2>&1; then
            RESULTS_JSON="${RESULTS_JSON_INPUT}"
          else
            RESULTS_JSON=$(jq -nc \
              --arg n1 "${SYSTEM1_NAME}" --arg r1 "${SYSTEM1_RESULT}" \
              --arg n2 "${SYSTEM2_NAME}" --arg r2 "${SYSTEM2_RESULT}" \
              --arg n3 "${SYSTEM3_NAME}" --arg r3 "${SYSTEM3_RESULT}" \
              '{($n1):$r1, ($n2):$r2, ($n3):$r3}')
          fi

          CHECKLIST=$(echo "${SYSTEMS_JSON}" | jq -r --arg label "${CONTEXT_LABEL}" 'map("- [ ] Verified \(.name) on \($label)") | join("\n")')
          ROWS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson urls "${DEPLOYMENT_URLS_JSON}" '.[] | "| \(.name) | " + (($urls[.name] // "Not deployed (no changes)")) + " |"')

          if [ "${DIRECTION}" = "test-to-uat" ]; then
            CHECKLIST+=$'\n- [ ] Ready for UAT validation'
          else
            CHECKLIST+=$'\n- [ ] All acceptance criteria met'
          fi

          AVAILABLE_LINKS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson urls "${DEPLOYMENT_URLS_JSON}" '[.[] | select((($urls[.name] // "") | length) > 0)] | length')

          EVIDENCE_ROWS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson results "${RESULTS_JSON}" '.[] | "| CI â€” \(.name) | " + (($results[.name] // "unknown")) + " |"')
          EVIDENCE_ROWS=$(printf "%s\n| Deployment Links | %s available |" "${EVIDENCE_ROWS}" "${AVAILABLE_LINKS}")
          if [ "${DIRECTION}" = "test-to-uat" ]; then
            EVIDENCE_ROWS=$(printf "%s\n| Version Tag | %s |" "${EVIDENCE_ROWS}" "${VERSION_TAG}")
          fi

          DETAILS=$(printf -- "- **Source branch:** %s\n- **Target branch:** %s" "${SOURCE_BRANCH}" "${TARGET_BRANCH}")
          if [ "${DIRECTION}" = "test-to-uat" ]; then
            DETAILS=$(printf "%s\n- **Version tag:** \`%s\`" "${DETAILS}" "${VERSION_TAG}")
          fi
          DETAILS=$(printf "%s\n- **Commit:** \`%s\`\n- **Compare:** [View changes](%s)\n- **Triggered at:** %s\n- **Pipeline run:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" "${DETAILS}" "${SHORT_SHA}" "${COMPARE_URL}" "${TIMESTAMP}")

          PR_BODY=$(cat <<ENDOFBODY
          ${HEADER}

          ${INTRO}

          ### ðŸ“‹ Pre-merge Checklist
          ${CHECKLIST}

          ### ðŸ”— Vercel ${CONTEXT_LABEL} Deployment Links
          | System | ${CONTEXT_LABEL} Preview Link |
          |--------|------------------|
          ${ROWS}

          ### âœ… Evidence
          | Check | Status |
          |-------|--------|
          ${EVIDENCE_ROWS}

          ### ðŸ” Details
          ${DETAILS}

          ---
          ${FOOTER}
          ENDOFBODY
          )

          if [ "${DRY_RUN}" = "true" ]; then
            echo "ðŸ§ª Dry run enabled. PR body preview:"
            echo "${PR_BODY}"
            exit 0
          fi

          if [ -n "${EXISTING_PR}" ]; then
            retry 3 3 gh pr edit "${EXISTING_PR}" --body "${PR_BODY}"
            echo "âœ… Updated PR #${EXISTING_PR}: ${SOURCE_BRANCH} â†’ ${TARGET_BRANCH}"
            exit 0
          fi

          retry 3 3 gh pr create --base "${TARGET_BRANCH}" --head "${SOURCE_BRANCH}" --title "${TITLE}" --body "${PR_BODY}"
          echo "âœ… Created PR: ${SOURCE_BRANCH} â†’ ${TARGET_BRANCH}"
