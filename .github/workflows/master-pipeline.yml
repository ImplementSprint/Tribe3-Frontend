# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  MASTER PIPELINE ORCHESTRATOR                                  â•‘
# â•‘  Coordinates all tribe system pipelines in parallel            â•‘
# â•‘                                                                â•‘
# â•‘  Branch Strategy (feature-based):                              â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â•‘
# â•‘  â”‚  feature/*    â”‚  Developer works on feature branch          â•‘
# â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â•‘
# â•‘       â–¼  PR                                                    â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â•‘
# â•‘  â”‚  test     â”‚  CI only â†’ auto-promote to uat                  â•‘
# â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                  â•‘
# â•‘       â–¼  PR                                                    â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â•‘
# â•‘  â”‚  uat      â”‚  CI + Deploy UAT â†’ auto-promote to main         â•‘
# â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                  â•‘
# â•‘       â–¼  PR                                                    â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â•‘
# â•‘  â”‚  main     â”‚  CI + Production Gate + Deploy to Prod          â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â•‘
# â•‘                                                                â•‘
# â•‘  Only 2 manual steps: (1) PR to test, (2) prod gate approval   â•‘
# â•‘  All 3 systems run in PARALLEL at every stage.                 â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "Master Pipeline Orchestrator"

on:
  push:
    branches: [test, uat, main]
  pull_request:
    branches: [test, uat, main]

permissions:
  contents: write
  packages: write
  pull-requests: write

concurrency:
  group: master-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  STAGE 0 â€” Detect Changes (skip unchanged sub-projects)    â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-changes:
    name: "Detect Changed Projects"
    runs-on: ubuntu-latest
    outputs:
      bayanihub-web: ${{ steps.filter.outputs.bayanihub-web }}
      damayan-web: ${{ steps.filter.outputs.damayan-web }}
      hopecard-web: ${{ steps.filter.outputs.hopecard-web }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            bayanihub-web:
              - 'BayaniHub-Web/**'
            damayan-web:
              - 'DAMAYAN-Web/**'
            hopecard-web:
              - 'HopeCard-Web/**'
            shared:
              - '.github/**'
              - 'package.json'
              - 'sonar-project.properties'

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  STAGE 1 â€” All Frontend Pipelines (PARALLEL)               â•‘
  # â•‘  Tests + Lint + Security + SonarCloud + Build               â•‘
  # â•‘  Each only runs if its files changed (or shared files)      â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  bayanihub-web:
    name: "BayaniHub-Web Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.bayanihub-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: BayaniHub-Web
      system-name: BayaniHub-Web
      enable-security-scan: false  # TODO: re-enable once GITLEAKS_LICENSE secret is added
    secrets: inherit

  damayan-web:
    name: "DAMAYAN-Web Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.damayan-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: DAMAYAN-Web
      system-name: DAMAYAN-Web
      enable-security-scan: false  # TODO: re-enable once GITLEAKS_LICENSE secret is added
    secrets: inherit

  hopecard-web:
    name: "HopeCard-Web Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.hopecard-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: HopeCard-Web
      system-name: HopeCard-Web
      enable-security-scan: false  # TODO: re-enable once GITLEAKS_LICENSE secret is added
    secrets: inherit

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  STAGE 1.5 â€” SonarCloud (single monorepo scan)             â•‘
  # â•‘  Runs ONCE after all sub-project tests pass                 â•‘
  # â•‘  Collects all coverage reports into one analysis            â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sonarcloud:
    name: "SonarCloud â€” Monorepo Analysis"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      needs.bayanihub-web.result != 'cancelled' &&
      needs.damayan-web.result != 'cancelled' &&
      needs.hopecard-web.result != 'cancelled'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download BayaniHub-Web Coverage
        if: needs.bayanihub-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: BayaniHub-Web-coverage
          path: BayaniHub-Web/coverage
        continue-on-error: true

      - name: Download DAMAYAN-Web Coverage
        if: needs.damayan-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: DAMAYAN-Web-coverage
          path: DAMAYAN-Web/coverage
        continue-on-error: true

      - name: Download HopeCard-Web Coverage
        if: needs.hopecard-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: HopeCard-Web-coverage
          path: HopeCard-Web/coverage
        continue-on-error: true

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  STAGE 2 â€” Deploy to UAT (uat branch only, PARALLEL)       â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-uat-bayanihub:
    name: "UAT â€” BayaniHub-Web"
    needs: [bayanihub-web]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      needs.bayanihub-web.result == 'success'
    uses: ./.github/workflows/deploy-staging.yml
    with:
      system-dir: BayaniHub-Web
      system-name: BayaniHub-Web
      app-type: web
      artifact-name: BayaniHub-Web-web-build
      deploy-environment: uat
    secrets: inherit

  deploy-uat-damayan:
    name: "UAT â€” DAMAYAN-Web"
    needs: [damayan-web]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      needs.damayan-web.result == 'success'
    uses: ./.github/workflows/deploy-staging.yml
    with:
      system-dir: DAMAYAN-Web
      system-name: DAMAYAN-Web
      app-type: web
      artifact-name: DAMAYAN-Web-web-build
      deploy-environment: uat
    secrets: inherit

  deploy-uat-hopecard:
    name: "UAT â€” HopeCard-Web"
    needs: [hopecard-web]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      needs.hopecard-web.result == 'success'
    uses: ./.github/workflows/deploy-staging.yml
    with:
      system-dir: HopeCard-Web
      system-name: HopeCard-Web
      app-type: web
      artifact-name: HopeCard-Web-web-build
      deploy-environment: uat
    secrets: inherit

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  STAGE 3 â€” Deploy to Prod (main branch only)               â•‘
  # â•‘  UAT was already verified on the uat branch.                â•‘
  # â•‘  Step 1: Production gate (approval + checklist)             â•‘
  # â•‘  Step 2: Deploy to Prod                                     â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€ Step 3A: Production Gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  production-gate:
    name: "Production Readiness Gate"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && github.event_name == 'push' &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped')
    uses: ./.github/workflows/production-gate.yml
    with:
      system-dir: Tribe3-Frontend
      app-type: web
    secrets: inherit

  # â”€â”€ Step 3B: Deploy to Prod (after gate approval) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-prod-bayanihub:
    name: "Prod â€” BayaniHub-Web"
    needs: [production-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/deploy-staging.yml
    with:
      system-dir: BayaniHub-Web
      system-name: BayaniHub-Web
      app-type: web
      artifact-name: BayaniHub-Web-web-build
      deploy-environment: prod
    secrets: inherit

  deploy-prod-damayan:
    name: "Prod â€” DAMAYAN-Web"
    needs: [production-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/deploy-staging.yml
    with:
      system-dir: DAMAYAN-Web
      system-name: DAMAYAN-Web
      app-type: web
      artifact-name: DAMAYAN-Web-web-build
      deploy-environment: prod
    secrets: inherit

  deploy-prod-hopecard:
    name: "Prod â€” HopeCard-Web"
    needs: [production-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/deploy-staging.yml
    with:
      system-dir: HopeCard-Web
      system-name: HopeCard-Web
      app-type: web
      artifact-name: HopeCard-Web-web-build
      deploy-environment: prod
    secrets: inherit

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  AUTO-PROMOTE â€” Cascade through branches automatically      â•‘
  # â•‘  test â†’ uat (after CI passes)                                â•‘
  # â•‘  uat â†’ main (after CI + UAT deploy passes)                   â•‘
  # â•‘  Only the production gate on main requires manual approval.  â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # â”€â”€ Auto-promote: test â†’ uat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  auto-promote-to-uat:
    name: "Auto-Promote â†’ UAT"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge test â†’ uat
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin uat
          git checkout uat
          git merge origin/test --no-edit -m "Auto-promote: test â†’ uat"
          git push origin uat
          echo "âœ… Auto-promoted test â†’ uat"

  # â”€â”€ Auto-promote: uat â†’ main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  auto-promote-to-main:
    name: "Auto-Promote â†’ Main"
    needs: [bayanihub-web, damayan-web, hopecard-web, deploy-uat-bayanihub, deploy-uat-damayan, deploy-uat-hopecard]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped') &&
      (needs.deploy-uat-bayanihub.result == 'success' || needs.deploy-uat-bayanihub.result == 'skipped') &&
      (needs.deploy-uat-damayan.result == 'success' || needs.deploy-uat-damayan.result == 'skipped') &&
      (needs.deploy-uat-hopecard.result == 'success' || needs.deploy-uat-hopecard.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge uat â†’ main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git merge origin/uat --no-edit -m "Auto-promote: uat â†’ main"
          git push origin main
          echo "âœ… Auto-promoted uat â†’ main"

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  STAGE 4 â€” Pipeline Summary & Notifications                â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pipeline-summary:
    name: "Pipeline Summary"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline Results
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          MASTER PIPELINE SUMMARY                     â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Repository: ${{ github.repository }}"
          echo "â•‘ Branch:     ${{ github.ref_name }}"
          echo "â•‘ Commit:     ${{ github.sha }}"
          echo "â•‘ Actor:      ${{ github.actor }}"
          echo "â•‘ Timestamp:  $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ BayaniHub-Web:   ${{ needs.bayanihub-web.result }}"
          echo "â•‘ DAMAYAN-Web:     ${{ needs.damayan-web.result }}"
          echo "â•‘ HopeCard-Web:    ${{ needs.hopecard-web.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          FAILED=false
          if [[ "${{ needs.bayanihub-web.result }}" == "failure" ]]; then FAILED=true; fi
          if [[ "${{ needs.damayan-web.result }}" == "failure" ]]; then FAILED=true; fi
          if [[ "${{ needs.hopecard-web.result }}" == "failure" ]]; then FAILED=true; fi

          if [ "$FAILED" = "true" ]; then
            echo "âŒ One or more pipelines failed!"
            exit 1
          fi
          echo "âœ… All pipelines completed successfully!"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "ğŸ”” Pipeline failure notification"
          echo "Failed pipelines detected for commit ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add Slack/Discord/Email notification here
          # curl -X POST "$SLACK_WEBHOOK" -d '{"text": "Pipeline failed..."}'

