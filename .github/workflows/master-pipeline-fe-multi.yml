# ╔══════════════════════════════════════════════════════════════════╗
# ║  MASTER PIPELINE ORCHESTRATOR                                  ║
# ║  Coordinates all tribe system pipelines in parallel            ║
# ║                                                                ║
# ║  Branch Strategy (feature-based):                              ║
# ║  ┌──────────────┐                                              ║
# ║  │  feature/*    │  Developer works on feature branch          ║
# ║  └────┬─────────┘                                              ║
# ║       ▼  PR                                                    ║
# ║  ┌──────────┐                                                  ║
# ║  │  test     │  CI only → auto-promote to uat                  ║
# ║  └────┬─────┘                                                  ║
# ║       ▼  PR                                                    ║
# ║  ┌──────────┐                                                  ║
# ║  │  uat      │  CI + Deploy UAT → auto-promote to main         ║
# ║  └────┬─────┘                                                  ║
# ║       ▼  PR (manual approval)                                  ║
# ║  ┌──────────┐                                                  ║
# ║  │  main     │  CI + Production Gate + Deploy to Prod          ║
# ║  └──────────┘                                                  ║
# ║                                                                ║
# ║  Only 2 manual steps: (1) PR to test, (2) prod gate approval   ║
# ║  All 3 systems run in PARALLEL at every stage.                 ║
# ╚══════════════════════════════════════════════════════════════════╝
name: "Master Pipeline Orchestrator"

on:
  push:
    branches: [test, uat, main]
  pull_request:
    branches: [test, uat, main]
  workflow_dispatch:
    inputs:
      run_deploy:
        description: "Run deploy jobs"
        type: boolean
        default: true
      run_promotion:
        description: "Run PR promotion jobs"
        type: boolean
        default: true
      dry_run:
        description: "Preview-only mode (skip deploy/tag push, print PR body)"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  pull-requests: write

# Optional secret for orgs that block GITHUB_TOKEN PR creation:
# GH_PR_TOKEN (preferred) or GHPR_TOKEN (legacy)
#
# Optional repository variables for reuse/customization:
# FE_MULTI_APP1_DIR (default: BayaniHub-Web)
# FE_MULTI_APP2_DIR (default: DAMAYAN-Web)
# FE_MULTI_APP3_DIR (default: HopeCard-Web)
# FE_MULTI_APP1_NAME (default: BayaniHub-Web)
# FE_MULTI_APP2_NAME (default: DAMAYAN-Web)
# FE_MULTI_APP3_NAME (default: HopeCard-Web)
# FE_MULTI_APP1_IMAGE (default: bayanihub-web)
# FE_MULTI_APP2_IMAGE (default: damayan-web)
# FE_MULTI_APP3_IMAGE (default: hopecard-web)
# FE_MULTI_APP1_VERCEL_PROJECT_SECRET (required, no default)
# FE_MULTI_APP2_VERCEL_PROJECT_SECRET (required, no default)
# FE_MULTI_APP3_VERCEL_PROJECT_SECRET (required, no default)
# FE_MULTI_PR_TOKEN_SECRET (default: GH_PR_TOKEN)

concurrency:
  group: master-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 0 — Detect Changes (skip unchanged sub-projects)    ║
  # ╚══════════════════════════════════════════════════════════════╝
  detect-changes:
    name: "Detect Changed Projects"
    runs-on: ubuntu-latest
    outputs:
      bayanihub-web: ${{ steps.filter.outputs.bayanihub-web }}
      damayan-web: ${{ steps.filter.outputs.damayan-web }}
      hopecard-web: ${{ steps.filter.outputs.hopecard-web }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            bayanihub-web:
              - '${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'BayaniHub-Web' }}/**'
            damayan-web:
              - '${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'DAMAYAN-Web' }}/**'
            hopecard-web:
              - '${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'HopeCard-Web' }}/**'
            shared:
              - '.github/**'
              - 'package.json'
              - 'sonar-project.properties'

  validate-vercel-secret-vars:
    name: "Validate Vercel Secret-Name Variables"
    runs-on: ubuntu-latest
    steps:
      - name: Ensure required vars are set
        env:
          APP1_SECRET_VAR: ${{ vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET }}
          APP2_SECRET_VAR: ${{ vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET }}
          APP3_SECRET_VAR: ${{ vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET }}
        run: |
          if [ -z "${APP1_SECRET_VAR}" ] || [ -z "${APP2_SECRET_VAR}" ] || [ -z "${APP3_SECRET_VAR}" ]; then
            echo "❌ Missing required repository variables for Vercel project secret names."
            echo "Set FE_MULTI_APP1_VERCEL_PROJECT_SECRET, FE_MULTI_APP2_VERCEL_PROJECT_SECRET, FE_MULTI_APP3_VERCEL_PROJECT_SECRET."
            exit 1
          fi

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 1 — All Frontend Pipelines (PARALLEL)               ║
  # ║  Tests + Lint + Security + SonarCloud + Build               ║
  # ║  Each only runs if its files changed (or shared files)      ║
  # ╚══════════════════════════════════════════════════════════════╝
  bayanihub-web:
    name: "${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }} Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.bayanihub-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'BayaniHub-Web' }}
      system-name: ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}
      enable-security-scan: true
    secrets: inherit

  damayan-web:
    name: "${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }} Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.damayan-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'DAMAYAN-Web' }}
      system-name: ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}
      enable-security-scan: true
    secrets: inherit

  hopecard-web:
    name: "${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }} Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.hopecard-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'HopeCard-Web' }}
      system-name: ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}
      enable-security-scan: true
    secrets: inherit

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 1.5 — SonarCloud (single monorepo scan)             ║
  # ║  Runs ONCE after all sub-project tests pass                 ║
  # ║  Collects all coverage reports into one analysis            ║
  # ╚══════════════════════════════════════════════════════════════╝
  sonarcloud:
    name: "SonarCloud — Monorepo Analysis"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      needs.bayanihub-web.result != 'cancelled' &&
      needs.damayan-web.result != 'cancelled' &&
      needs.hopecard-web.result != 'cancelled'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download BayaniHub-Web Coverage
        if: needs.bayanihub-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: BayaniHub-Web-coverage
          path: BayaniHub-Web/coverage
        continue-on-error: true

      - name: Download DAMAYAN-Web Coverage
        if: needs.damayan-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: DAMAYAN-Web-coverage
          path: DAMAYAN-Web/coverage
        continue-on-error: true

      - name: Download HopeCard-Web Coverage
        if: needs.hopecard-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: HopeCard-Web-coverage
          path: HopeCard-Web/coverage
        continue-on-error: true

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 1.6 — Versioning (test branch)                       ║
  # ║  Creates a git tag on every successful merge to test        ║
  # ╚══════════════════════════════════════════════════════════════╝
  version-test:
    name: "Version Tag — TEST"
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.dry_run != 'true')
    uses: ./.github/workflows/versioning.yml
    with:
      mode: test

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 2 — Deploy to TEST via Vercel (test branch, PARALLEL)║
  # ║  Uses VERCEL_PROJECT_ID_* secrets per sub-project           ║
  # ╚══════════════════════════════════════════════════════════════╝
  deploy-test-bayanihub:
    name: "TEST — ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}"
    needs: [bayanihub-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      needs.bayanihub-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'BayaniHub-Web' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET] }}

  deploy-test-damayan:
    name: "TEST — ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}"
    needs: [damayan-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      needs.damayan-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'DAMAYAN-Web' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET] }}

  deploy-test-hopecard:
    name: "TEST — ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}"
    needs: [hopecard-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      needs.hopecard-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'HopeCard-Web' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET] }}

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 3 — Deploy to UAT via Vercel (uat branch, PARALLEL)  ║
  # ║  Uses VERCEL_PROJECT_ID_* secrets per sub-project           ║
  # ╚══════════════════════════════════════════════════════════════╝
  deploy-uat-bayanihub:
    name: "UAT — ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}"
    needs: [bayanihub-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      needs.bayanihub-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'BayaniHub-Web' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET] }}

  deploy-uat-damayan:
    name: "UAT — ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}"
    needs: [damayan-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      needs.damayan-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'DAMAYAN-Web' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET] }}

  deploy-uat-hopecard:
    name: "UAT — ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}"
    needs: [hopecard-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      needs.hopecard-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'HopeCard-Web' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET] }}

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 4 — Deploy to Prod via Vercel (main branch only)    ║
  # ║  Uses VERCEL_PROJECT_ID_* secrets per sub-project          ║
  # ║  Step 1: Production gate (checklist + audit)               ║
  # ║  Step 2: Deploy to Prod via Vercel                         ║
  # ╚══════════════════════════════════════════════════════════════╝

  # ── Step 3A: Production Gate ───────────────────────────────────
  production-gate:
    name: "Production Readiness Gate"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped')
    uses: ./.github/workflows/production-gate.yml
    with:
      system-dir: Tribe3-Frontend
      app-type: web
    secrets: inherit

  # ── Step 3B: Deploy to Prod via Vercel (after gate) ────────────
  deploy-prod-bayanihub:
    name: "Prod — ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}"
    needs: [production-gate, validate-vercel-secret-vars]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true'))
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'BayaniHub-Web' }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET] }}

  deploy-prod-damayan:
    name: "Prod — ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}"
    needs: [production-gate, validate-vercel-secret-vars]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true'))
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'DAMAYAN-Web' }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET] }}

  deploy-prod-hopecard:
    name: "Prod — ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}"
    needs: [production-gate, validate-vercel-secret-vars]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true'))
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'HopeCard-Web' }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET] }}

  # ── Step 3C: Versioning (main branch release tag) ─────────────
  version-main-release:
    name: "Version Tag — MAIN Release"
    needs: [deploy-prod-bayanihub, deploy-prod-damayan, deploy-prod-hopecard]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.dry_run != 'true') &&
      (needs.deploy-prod-bayanihub.result == 'success' || needs.deploy-prod-bayanihub.result == 'skipped') &&
      (needs.deploy-prod-damayan.result == 'success' || needs.deploy-prod-damayan.result == 'skipped') &&
      (needs.deploy-prod-hopecard.result == 'success' || needs.deploy-prod-hopecard.result == 'skipped')
    uses: ./.github/workflows/versioning.yml
    with:
      mode: main

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 5 — Build & Push Docker Images to GHCR (main only)  ║
  # ║  One image per frontend app                                 ║
  # ╚══════════════════════════════════════════════════════════════╝
  docker-main:
    name: "GHCR — ${{ matrix.app_name }}"
    needs: [version-main-release]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - app_name: ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}
            working_directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'BayaniHub-Web' }}
            image_name: ${{ vars.FE_MULTI_APP1_IMAGE != '' && vars.FE_MULTI_APP1_IMAGE || 'bayanihub-web' }}
          - app_name: ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}
            working_directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'DAMAYAN-Web' }}
            image_name: ${{ vars.FE_MULTI_APP2_IMAGE != '' && vars.FE_MULTI_APP2_IMAGE || 'damayan-web' }}
          - app_name: ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}
            working_directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'HopeCard-Web' }}
            image_name: ${{ vars.FE_MULTI_APP3_IMAGE != '' && vars.FE_MULTI_APP3_IMAGE || 'hopecard-web' }}
    uses: ./.github/workflows/docker-build.yml
    with:
      working-directory: ${{ matrix.working_directory }}
      image-name: ${{ matrix.image_name }}
      release-tag: ${{ needs.version-main-release.outputs.version_tag }}
      push-image: true
      scan-vulnerabilities: true
    secrets: inherit

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  PROMOTION — PR-based branch progression                    ║
  # ║  test → uat: create PR with TEST Vercel links              ║
  # ║  uat → main: creates PR with UAT Vercel links              ║
  # ╚══════════════════════════════════════════════════════════════╝

  # ── Promotion: test → uat (creates PR for manual approval) ────
  create-pr-to-uat:
    name: "Create PR → UAT"
    needs: [bayanihub-web, damayan-web, hopecard-web, version-test, deploy-test-bayanihub, deploy-test-damayan, deploy-test-hopecard]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.run_promotion == 'true') &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped') &&
      needs.version-test.result == 'success' &&
      (needs.deploy-test-bayanihub.result == 'success' || needs.deploy-test-bayanihub.result == 'skipped') &&
      (needs.deploy-test-damayan.result == 'success' || needs.deploy-test-damayan.result == 'skipped') &&
      (needs.deploy-test-hopecard.result == 'success' || needs.deploy-test-hopecard.result == 'skipped')
    uses: ./.github/workflows/promotion.yml
    with:
      pipeline-kind: multi
      direction: test-to-uat
      system1-name: ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}
      system2-name: ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}
      system3-name: ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}
      system1-url: ${{ needs.deploy-test-bayanihub.outputs.deployment_url }}
      system2-url: ${{ needs.deploy-test-damayan.outputs.deployment_url }}
      system3-url: ${{ needs.deploy-test-hopecard.outputs.deployment_url }}
      system1-result: ${{ needs.bayanihub-web.result }}
      system2-result: ${{ needs.damayan-web.result }}
      system3-result: ${{ needs.hopecard-web.result }}
      version-tag: ${{ needs.version-test.outputs.version_tag }}
      dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets:
      PR_TOKEN: ${{ secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}

  # ── Promotion: uat → main (creates PR for manual approval) ──────
  create-pr-to-main:
    name: "Create PR → Main"
    needs: [bayanihub-web, damayan-web, hopecard-web, deploy-uat-bayanihub, deploy-uat-damayan, deploy-uat-hopecard]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.run_promotion == 'true') &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped') &&
      (needs.deploy-uat-bayanihub.result == 'success' || needs.deploy-uat-bayanihub.result == 'skipped') &&
      (needs.deploy-uat-damayan.result == 'success' || needs.deploy-uat-damayan.result == 'skipped') &&
      (needs.deploy-uat-hopecard.result == 'success' || needs.deploy-uat-hopecard.result == 'skipped')
    uses: ./.github/workflows/promotion.yml
    with:
      pipeline-kind: multi
      direction: uat-to-main
      system1-name: ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}
      system2-name: ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}
      system3-name: ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}
      system1-url: ${{ needs.deploy-uat-bayanihub.outputs.deployment_url }}
      system2-url: ${{ needs.deploy-uat-damayan.outputs.deployment_url }}
      system3-url: ${{ needs.deploy-uat-hopecard.outputs.deployment_url }}
      system1-result: ${{ needs.bayanihub-web.result }}
      system2-result: ${{ needs.damayan-web.result }}
      system3-result: ${{ needs.hopecard-web.result }}
      dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets:
      PR_TOKEN: ${{ secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}

  # ╔══════════════════════════════════════════════════════════════╗
  # ║  STAGE 4 — Pipeline Summary & Notifications                ║
  # ╚══════════════════════════════════════════════════════════════╝
  pipeline-summary:
    name: "Pipeline Summary"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: always()
    uses: ./.github/workflows/pipeline-summary.yml
    with:
      pipeline-kind: multi
      system1-name: ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}
      system2-name: ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}
      system3-name: ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}
      system1-result: ${{ needs.bayanihub-web.result }}
      system2-result: ${{ needs.damayan-web.result }}
      system3-result: ${{ needs.hopecard-web.result }}

  notify-pipeline:
    name: "Notify Pipeline Status"
    needs: [pipeline-summary]
    if: always()
    uses: ./.github/workflows/notifications.yml
    with:
      status: ${{ needs.pipeline-summary.result == 'success' && 'success' || (needs.pipeline-summary.result == 'cancelled' && 'cancelled' || 'failure') }}
      system-dir: ${{ format('{0}, {1}, {2}', vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web', vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web', vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web') }}
      pipeline-type: FE Multi Master
      error-details: ${{ needs.pipeline-summary.result != 'success' && 'Master FE multi pipeline reported failures.' || '' }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

