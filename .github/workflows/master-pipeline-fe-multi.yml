name: "Master Pipeline Orchestrator"

on:
  push:
    branches: [test, uat, main]
  pull_request:
    branches: [test, uat, main]
  workflow_dispatch:
    inputs:
      run_deploy:
        description: "Run deploy jobs"
        type: boolean
        default: true
      run_promotion:
        description: "Run PR promotion jobs"
        type: boolean
        default: true
      dry_run:
        description: "Preview-only mode (skip deploy/tag push, print PR body)"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  pull-requests: write

concurrency:
  group: master-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  systems-config:
    name: "Resolve Systems Configuration"
    runs-on: ubuntu-latest
    outputs:
      systems_json: ${{ steps.resolve.outputs.systems_json }}
      systems_label: ${{ steps.resolve.outputs.systems_label }}
    steps:
      - name: Resolve systems JSON
        id: resolve
        env:
          SYSTEMS_JSON_VAR: ${{ vars.FE_MULTI_SYSTEMS_JSON }}
          APP1_NAME: ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'BayaniHub-Web' }}
          APP2_NAME: ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'DAMAYAN-Web' }}
          APP3_NAME: ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'HopeCard-Web' }}
          APP1_DIR: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'BayaniHub-Web' }}
          APP2_DIR: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'DAMAYAN-Web' }}
          APP3_DIR: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'HopeCard-Web' }}
          APP1_IMAGE: ${{ vars.FE_MULTI_APP1_IMAGE != '' && vars.FE_MULTI_APP1_IMAGE || 'bayanihub-web' }}
          APP2_IMAGE: ${{ vars.FE_MULTI_APP2_IMAGE != '' && vars.FE_MULTI_APP2_IMAGE || 'damayan-web' }}
          APP3_IMAGE: ${{ vars.FE_MULTI_APP3_IMAGE != '' && vars.FE_MULTI_APP3_IMAGE || 'hopecard-web' }}
          APP1_VERCEL_SECRET: ${{ vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET }}
          APP2_VERCEL_SECRET: ${{ vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET }}
          APP3_VERCEL_SECRET: ${{ vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET }}
        run: |
          if [ -n "${SYSTEMS_JSON_VAR}" ]; then
            SYSTEMS_JSON="${SYSTEMS_JSON_VAR}"
          else
            SYSTEMS_JSON=$(jq -nc \
              --arg n1 "${APP1_NAME}" --arg d1 "${APP1_DIR}" --arg i1 "${APP1_IMAGE}" --arg v1 "${APP1_VERCEL_SECRET}" \
              --arg n2 "${APP2_NAME}" --arg d2 "${APP2_DIR}" --arg i2 "${APP2_IMAGE}" --arg v2 "${APP2_VERCEL_SECRET}" \
              --arg n3 "${APP3_NAME}" --arg d3 "${APP3_DIR}" --arg i3 "${APP3_IMAGE}" --arg v3 "${APP3_VERCEL_SECRET}" \
              '[
                {name:$n1,dir:$d1,image:$i1,vercel_project_secret:$v1},
                {name:$n2,dir:$d2,image:$i2,vercel_project_secret:$v2},
                {name:$n3,dir:$d3,image:$i3,vercel_project_secret:$v3}
              ] | map(select(.name != ""))')
          fi

          echo "${SYSTEMS_JSON}" | jq -e . >/dev/null
          echo "${SYSTEMS_JSON}" | jq -e 'type == "array" and length > 0' >/dev/null
          echo "${SYSTEMS_JSON}" | jq -e 'all(.[]; (.name|type=="string" and length>0) and (.dir|type=="string" and length>0) and (.image|type=="string" and length>0) and (.vercel_project_secret|type=="string" and length>0))' >/dev/null

          SYSTEMS_LABEL=$(echo "${SYSTEMS_JSON}" | jq -r 'map(.name) | join(", ")')

          echo "systems_json=${SYSTEMS_JSON}" >> "$GITHUB_OUTPUT"
          echo "systems_label=${SYSTEMS_LABEL}" >> "$GITHUB_OUTPUT"

  active-systems:
    name: "Detect Active Systems"
    needs: [systems-config]
    runs-on: ubuntu-latest
    outputs:
      active_systems_json: ${{ steps.select.outputs.active_systems_json }}
      active_count: ${{ steps.select.outputs.active_count }}
      active_label: ${{ steps.select.outputs.active_label }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select active systems
        id: select
        env:
          SYSTEMS_JSON: ${{ needs.systems-config.outputs.systems_json }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ACTIVE="${SYSTEMS_JSON}"
          else
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
            else
              BASE_SHA="${{ github.event.before }}"
            fi

            if [ -z "${BASE_SHA}" ] || [ "${BASE_SHA}" = "0000000000000000000000000000000000000000" ]; then
              BASE_SHA=$(git rev-parse HEAD^ 2>/dev/null || git rev-parse HEAD)
            fi

            CHANGED_FILES=$(git diff --name-only "${BASE_SHA}" "${GITHUB_SHA}" || true)
            CHANGED_JSON=$(printf "%s\n" "${CHANGED_FILES}" | sed '/^$/d' | jq -R . | jq -s .)

            SHARED_CHANGED=false
            if printf "%s\n" "${CHANGED_FILES}" | grep -Eq '^(\.github/|package\.json$|sonar-project\.properties$)'; then
              SHARED_CHANGED=true
            fi

            if [ "${SHARED_CHANGED}" = "true" ]; then
              ACTIVE="${SYSTEMS_JSON}"
            else
              ACTIVE=$(echo "${SYSTEMS_JSON}" | jq -c --argjson changed "${CHANGED_JSON}" '
                map(select(any($changed[]; startswith((.dir | gsub("^\\./"; "") ) + "/"))))
              ')
            fi
          fi

          ACTIVE_COUNT=$(echo "${ACTIVE}" | jq 'length')
          if [ "${ACTIVE_COUNT}" -gt 0 ]; then
            ACTIVE_LABEL=$(echo "${ACTIVE}" | jq -r 'map(.name) | join(", ")')
          else
            ACTIVE_LABEL="None"
          fi

          echo "active_systems_json=${ACTIVE}" >> "$GITHUB_OUTPUT"
          echo "active_count=${ACTIVE_COUNT}" >> "$GITHUB_OUTPUT"
          echo "active_label=${ACTIVE_LABEL}" >> "$GITHUB_OUTPUT"

  frontend:
    name: "Frontend — ${{ matrix.system.name }}"
    needs: [active-systems]
    if: fromJson(needs.active-systems.outputs.active_count) > 0
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.active-systems.outputs.active_systems_json) }}
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ matrix.system.dir }}
      system-name: ${{ matrix.system.name }}
      enable-security-scan: true
    secrets: inherit

  sonarcloud:
    name: "SonarCloud — Monorepo Analysis"
    needs: [frontend, active-systems]
    if: always() && needs.frontend.result != 'cancelled' && fromJson(needs.active-systems.outputs.active_count) > 0
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}

  version-test:
    name: "Version Tag — TEST"
    needs: [frontend, active-systems]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.dry_run != 'true') &&
      fromJson(needs.active-systems.outputs.active_count) > 0 &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    uses: ./.github/workflows/versioning.yml
    with:
      mode: test

  deploy-test:
    name: "TEST — ${{ matrix.system.name }}"
    needs: [frontend, active-systems]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      fromJson(needs.active-systems.outputs.active_count) > 0 &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.active-systems.outputs.active_systems_json) }}
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ matrix.system.dir }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[matrix.system.vercel_project_secret] }}

  deploy-uat:
    name: "UAT — ${{ matrix.system.name }}"
    needs: [frontend, active-systems]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      fromJson(needs.active-systems.outputs.active_count) > 0 &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.active-systems.outputs.active_systems_json) }}
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ matrix.system.dir }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[matrix.system.vercel_project_secret] }}

  production-gate:
    name: "Production Readiness Gate"
    needs: [frontend, active-systems]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      fromJson(needs.active-systems.outputs.active_count) > 0 &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    uses: ./.github/workflows/production-gate.yml
    with:
      system-dir: ${{ needs.active-systems.outputs.active_label }}
      app-type: web
    secrets: inherit

  deploy-prod:
    name: "Prod — ${{ matrix.system.name }}"
    needs: [production-gate, active-systems]
    if: >-
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      fromJson(needs.active-systems.outputs.active_count) > 0
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.active-systems.outputs.active_systems_json) }}
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ matrix.system.dir }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[matrix.system.vercel_project_secret] }}

  version-main-release:
    name: "Version Tag — MAIN Release"
    needs: [deploy-prod, active-systems]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.dry_run != 'true') &&
      fromJson(needs.active-systems.outputs.active_count) > 0 &&
      (needs.deploy-prod.result == 'success' || needs.deploy-prod.result == 'skipped')
    uses: ./.github/workflows/versioning.yml
    with:
      mode: main

  docker-main:
    name: "GHCR — ${{ matrix.system.name }}"
    needs: [version-main-release, active-systems]
    if: >-
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      fromJson(needs.active-systems.outputs.active_count) > 0
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.active-systems.outputs.active_systems_json) }}
    uses: ./.github/workflows/docker-build.yml
    with:
      working-directory: ${{ matrix.system.dir }}
      image-name: ${{ matrix.system.image }}
      release-tag: ${{ needs.version-main-release.outputs.version_tag }}
      push-image: true
      scan-vulnerabilities: true
    secrets: inherit

  create-pr-to-uat:
    name: "Create PR → UAT"
    needs: [frontend, version-test, deploy-test, active-systems]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.run_promotion == 'true') &&
      fromJson(needs.active-systems.outputs.active_count) > 0 &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped') &&
      needs.version-test.result == 'success' &&
      (needs.deploy-test.result == 'success' || needs.deploy-test.result == 'skipped')
    uses: ./.github/workflows/promotion.yml
    with:
      pipeline-kind: multi
      direction: test-to-uat
      systems-json: ${{ needs.active-systems.outputs.active_systems_json }}
      deployment-urls-json: '{}'
      results-json: '{}'
      version-tag: ${{ needs.version-test.outputs.version_tag }}
      dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets:
      PR_TOKEN: ${{ secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}

  create-pr-to-main:
    name: "Create PR → Main"
    needs: [frontend, deploy-uat, active-systems]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.run_promotion == 'true') &&
      fromJson(needs.active-systems.outputs.active_count) > 0 &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped') &&
      (needs.deploy-uat.result == 'success' || needs.deploy-uat.result == 'skipped')
    uses: ./.github/workflows/promotion.yml
    with:
      pipeline-kind: multi
      direction: uat-to-main
      systems-json: ${{ needs.active-systems.outputs.active_systems_json }}
      deployment-urls-json: '{}'
      results-json: '{}'
      dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets:
      PR_TOKEN: ${{ secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] != '' && secrets[vars.FE_MULTI_PR_TOKEN_SECRET != '' && vars.FE_MULTI_PR_TOKEN_SECRET || 'GH_PR_TOKEN'] || (secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GHPR_TOKEN) }}

  pipeline-summary:
    name: "Pipeline Summary"
    needs: [frontend, active-systems]
    if: always()
    uses: ./.github/workflows/pipeline-summary.yml
    with:
      pipeline-kind: multi
      systems-json: ${{ needs.active-systems.outputs.active_systems_json }}
      results-json: '{}'
      overall-result: ${{ needs.frontend.result }}

  notify-pipeline:
    name: "Notify Pipeline Status"
    needs: [pipeline-summary, frontend, active-systems]
    if: always()
    uses: ./.github/workflows/notifications.yml
    with:
      status: ${{ (needs.frontend.result == 'success' || needs.frontend.result == 'skipped') && 'success' || (needs.frontend.result == 'cancelled' && 'cancelled' || 'failure') }}
      system-dir: ${{ needs.active-systems.outputs.active_label }}
      pipeline-type: FE Multi Master
      error-details: ${{ needs.frontend.result != 'success' && needs.frontend.result != 'skipped' && 'Master FE multi pipeline reported failures.' || '' }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
