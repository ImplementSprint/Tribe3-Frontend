# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  MASTER PIPELINE ORCHESTRATOR                                  ‚ïë
# ‚ïë  Coordinates all tribe system pipelines in parallel            ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  Branch Strategy (feature-based):                              ‚ïë
# ‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                              ‚ïë
# ‚ïë  ‚îÇ  feature/*    ‚îÇ  Developer works on feature branch          ‚ïë
# ‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                              ‚ïë
# ‚ïë       ‚ñº  PR                                                    ‚ïë
# ‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                  ‚ïë
# ‚ïë  ‚îÇ  test     ‚îÇ  CI only ‚Üí auto-promote to uat                  ‚ïë
# ‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                  ‚ïë
# ‚ïë       ‚ñº  PR                                                    ‚ïë
# ‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                  ‚ïë
# ‚ïë  ‚îÇ  uat      ‚îÇ  CI + Deploy UAT ‚Üí auto-promote to main         ‚ïë
# ‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                  ‚ïë
# ‚ïë       ‚ñº  PR (manual approval)                                  ‚ïë
# ‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                  ‚ïë
# ‚ïë  ‚îÇ  main     ‚îÇ  CI + Production Gate + Deploy to Prod          ‚ïë
# ‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                  ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  Only 2 manual steps: (1) PR to test, (2) prod gate approval   ‚ïë
# ‚ïë  All 3 systems run in PARALLEL at every stage.                 ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
name: "Master Pipeline Orchestrator - FE Multi"

on:
  push:
    branches: [test, uat, main]
  pull_request:
    branches: [test, uat, main]

permissions:
  contents: write
  packages: write
  pull-requests: write

# Optional secret for orgs that block GITHUB_TOKEN PR creation:
# GH_PR_TOKEN (preferred) or GHPR_TOKEN (legacy)
# (can be defined at organization or repository level)
#
# Optional repository variables for reuse/customization:
# FE_MULTI_APP1_DIR (default: system-1)
# FE_MULTI_APP2_DIR (default: system-2)
# FE_MULTI_APP3_DIR (default: system-3)
# FE_MULTI_APP1_NAME (default: system-1)
# FE_MULTI_APP2_NAME (default: system-2)
# FE_MULTI_APP3_NAME (default: system-3)
# FE_MULTI_APP1_IMAGE (default: system-1-web)
# FE_MULTI_APP2_IMAGE (default: system-2-web)
# FE_MULTI_APP3_IMAGE (default: system-3-web)
# FE_MULTI_APP1_VERCEL_PROJECT_SECRET (required, no default)
# FE_MULTI_APP2_VERCEL_PROJECT_SECRET (required, no default)
# FE_MULTI_APP3_VERCEL_PROJECT_SECRET (required, no default)

concurrency:
  group: master-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 0 ‚Äî Detect Changes (skip unchanged sub-projects)    ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  detect-changes:
    name: "Detect Changed Projects"
    runs-on: ubuntu-latest
    outputs:
      bayanihub-web: ${{ steps.filter.outputs.bayanihub-web }}
      damayan-web: ${{ steps.filter.outputs.damayan-web }}
      hopecard-web: ${{ steps.filter.outputs.hopecard-web }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            bayanihub-web:
              - '${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'system-1' }}/**'
            damayan-web:
              - '${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'system-2' }}/**'
            hopecard-web:
              - '${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'system-3' }}/**'
            shared:
              - '.github/**'
              - 'package.json'
              - 'sonar-project.properties'

  validate-vercel-secret-vars:
    name: "Validate Vercel Secret-Name Variables"
    runs-on: ubuntu-latest
    steps:
      - name: Ensure required vars are set
        env:
          APP1_SECRET_VAR: ${{ vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET }}
          APP2_SECRET_VAR: ${{ vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET }}
          APP3_SECRET_VAR: ${{ vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET }}
        run: |
          if [ -z "${APP1_SECRET_VAR}" ] || [ -z "${APP2_SECRET_VAR}" ] || [ -z "${APP3_SECRET_VAR}" ]; then
            echo "‚ùå Missing required repository variables for Vercel project secret names."
            echo "Set FE_MULTI_APP1_VERCEL_PROJECT_SECRET, FE_MULTI_APP2_VERCEL_PROJECT_SECRET, FE_MULTI_APP3_VERCEL_PROJECT_SECRET."
            exit 1
          fi

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 1 ‚Äî All Frontend Pipelines (PARALLEL)               ‚ïë
  # ‚ïë  Tests + Lint + Security + SonarCloud + Build               ‚ïë
  # ‚ïë  Each only runs if its files changed (or shared files)      ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  bayanihub-web:
    name: "${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }} Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.bayanihub-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'system-1' }}
      system-name: ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }}
      enable-security-scan: true
    secrets: inherit

  damayan-web:
    name: "${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }} Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.damayan-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'system-2' }}
      system-name: ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }}
      enable-security-scan: true
    secrets: inherit

  hopecard-web:
    name: "${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }} Pipeline"
    needs: [detect-changes]
    if: needs.detect-changes.outputs.hopecard-web == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: ./.github/workflows/front-end-workflow.yml
    with:
      system-dir: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'system-3' }}
      system-name: ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }}
      enable-security-scan: true
    secrets: inherit

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 1.5 ‚Äî SonarCloud (single monorepo scan)             ‚ïë
  # ‚ïë  Runs ONCE after all sub-project tests pass                 ‚ïë
  # ‚ïë  Collects all coverage reports into one analysis            ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  sonarcloud:
    name: "SonarCloud ‚Äî Monorepo Analysis"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      needs.bayanihub-web.result != 'cancelled' &&
      needs.damayan-web.result != 'cancelled' &&
      needs.hopecard-web.result != 'cancelled'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download BayaniHub-Web Coverage
        if: needs.bayanihub-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: BayaniHub-Web-coverage
          path: BayaniHub-Web/coverage
        continue-on-error: true

      - name: Download DAMAYAN-Web Coverage
        if: needs.damayan-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: DAMAYAN-Web-coverage
          path: DAMAYAN-Web/coverage
        continue-on-error: true

      - name: Download HopeCard-Web Coverage
        if: needs.hopecard-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: HopeCard-Web-coverage
          path: HopeCard-Web/coverage
        continue-on-error: true

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 1.6 ‚Äî Versioning (test branch)                       ‚ïë
  # ‚ïë  Creates a git tag on every successful merge to test        ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  version-test:
    name: "Version Tag ‚Äî TEST"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Version Tag
        id: version
        run: |
          PREFIX="test-v"
          LATEST=$(git tag -l "${PREFIX}[0-9]*.[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)

          if [ -z "${LATEST}" ]; then
            NEXT_VERSION="1.0.0.0"
          else
            RAW_VERSION="${LATEST#${PREFIX}}"
            IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "${RAW_VERSION}"
            NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}.$((BUILD + 1))"
          fi

          TAG="${PREFIX}${NEXT_VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Tag already exists: ${TAG}"
            exit 0
          fi

          git tag -a "${TAG}" -m "TEST version ${TAG}"
          git push origin "${TAG}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "‚úÖ Created version tag: ${TAG}"

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 2 ‚Äî Deploy to TEST via Vercel (test branch, PARALLEL)‚ïë
  # ‚ïë  Uses VERCEL_PROJECT_ID_* secrets per sub-project           ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  deploy-test-bayanihub:
    name: "TEST ‚Äî ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }}"
    needs: [bayanihub-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      needs.bayanihub-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'system-1' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET] }}

  deploy-test-damayan:
    name: "TEST ‚Äî ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }}"
    needs: [damayan-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      needs.damayan-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'system-2' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET] }}

  deploy-test-hopecard:
    name: "TEST ‚Äî ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }}"
    needs: [hopecard-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      needs.hopecard-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'system-3' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET] }}

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 3 ‚Äî Deploy to UAT via Vercel (uat branch, PARALLEL)  ‚ïë
  # ‚ïë  Uses VERCEL_PROJECT_ID_* secrets per sub-project           ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  deploy-uat-bayanihub:
    name: "UAT ‚Äî ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }}"
    needs: [bayanihub-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      needs.bayanihub-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'system-1' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET] }}

  deploy-uat-damayan:
    name: "UAT ‚Äî ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }}"
    needs: [damayan-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      needs.damayan-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'system-2' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET] }}

  deploy-uat-hopecard:
    name: "UAT ‚Äî ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }}"
    needs: [hopecard-web, validate-vercel-secret-vars]
    if: |
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      needs.hopecard-web.result == 'success'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'system-3' }}
      environment: preview
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET] }}

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 4 ‚Äî Deploy to Prod via Vercel (main branch only)    ‚ïë
  # ‚ïë  Uses VERCEL_PROJECT_ID_* secrets per sub-project          ‚ïë
  # ‚ïë  Step 1: Production gate (checklist + audit)               ‚ïë
  # ‚ïë  Step 2: Deploy to Prod via Vercel                         ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

  # ‚îÄ‚îÄ Step 3A: Production Gate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  production-gate:
    name: "Production Readiness Gate"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && github.event_name == 'push' &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped')
    uses: ./.github/workflows/production-gate.yml
    with:
      system-dir: Tribe3-Frontend
      app-type: web
    secrets: inherit

  # ‚îÄ‚îÄ Step 3B: Deploy to Prod via Vercel (after gate) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy-prod-bayanihub:
    name: "Prod ‚Äî ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }}"
    needs: [production-gate, validate-vercel-secret-vars]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'system-1' }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP1_VERCEL_PROJECT_SECRET] }}

  deploy-prod-damayan:
    name: "Prod ‚Äî ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }}"
    needs: [production-gate, validate-vercel-secret-vars]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'system-2' }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP2_VERCEL_PROJECT_SECRET] }}

  deploy-prod-hopecard:
    name: "Prod ‚Äî ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }}"
    needs: [production-gate, validate-vercel-secret-vars]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/vercel-deploy.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'system-3' }}
      environment: production
    secrets:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets[vars.FE_MULTI_APP3_VERCEL_PROJECT_SECRET] }}

  # ‚îÄ‚îÄ Step 3C: Versioning (main branch release tag) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  version-main-release:
    name: "Version Tag ‚Äî MAIN Release"
    needs: [deploy-prod-bayanihub, deploy-prod-damayan, deploy-prod-hopecard]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && github.event_name == 'push' &&
      (needs.deploy-prod-bayanihub.result == 'success' || needs.deploy-prod-bayanihub.result == 'skipped') &&
      (needs.deploy-prod-damayan.result == 'success' || needs.deploy-prod-damayan.result == 'skipped') &&
      (needs.deploy-prod-hopecard.result == 'success' || needs.deploy-prod-hopecard.result == 'skipped')
    outputs:
      version_tag: ${{ steps.version.outputs.tag }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Release Tag
        id: version
        run: |
          TEST_PREFIX="test-v"
          MAIN_PREFIX="main-v"

          LATEST_TEST=$(git tag -l "${TEST_PREFIX}[0-9]*.[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          if [ -z "${LATEST_TEST}" ]; then
            echo "‚ùå No test version tag found. main release tag requires a prior test tag."
            exit 1
          fi

          VERSION_FROM_TEST="${LATEST_TEST#${TEST_PREFIX}}"
          TAG="${MAIN_PREFIX}${VERSION_FROM_TEST}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Tag already exists: ${TAG}"
            exit 0
          fi

          git tag -a "${TAG}" -m "MAIN release ${TAG}"
          git push origin "${TAG}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "‚úÖ Created release tag: ${TAG}"

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 5 ‚Äî Build & Push Docker Images to GHCR (main only)  ‚ïë
  # ‚ïë  One image per frontend app                                 ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  docker-main-bayanihub:
    name: "GHCR ‚Äî ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }}"
    needs: [version-main-release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/docker-build.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP1_DIR != '' && vars.FE_MULTI_APP1_DIR || 'system-1' }}
      image-name: ${{ vars.FE_MULTI_APP1_IMAGE != '' && vars.FE_MULTI_APP1_IMAGE || 'system-1-web' }}
      release-tag: ${{ needs.version-main-release.outputs.version_tag }}
      push-image: true
      scan-vulnerabilities: true
    secrets: inherit

  docker-main-damayan:
    name: "GHCR ‚Äî ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }}"
    needs: [version-main-release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/docker-build.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP2_DIR != '' && vars.FE_MULTI_APP2_DIR || 'system-2' }}
      image-name: ${{ vars.FE_MULTI_APP2_IMAGE != '' && vars.FE_MULTI_APP2_IMAGE || 'system-2-web' }}
      release-tag: ${{ needs.version-main-release.outputs.version_tag }}
      push-image: true
      scan-vulnerabilities: true
    secrets: inherit

  docker-main-hopecard:
    name: "GHCR ‚Äî ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }}"
    needs: [version-main-release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/docker-build.yml
    with:
      working-directory: ${{ vars.FE_MULTI_APP3_DIR != '' && vars.FE_MULTI_APP3_DIR || 'system-3' }}
      image-name: ${{ vars.FE_MULTI_APP3_IMAGE != '' && vars.FE_MULTI_APP3_IMAGE || 'system-3-web' }}
      release-tag: ${{ needs.version-main-release.outputs.version_tag }}
      push-image: true
      scan-vulnerabilities: true
    secrets: inherit

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  PROMOTION ‚Äî PR-based branch progression                    ‚ïë
  # ‚ïë  test ‚Üí uat: create PR with TEST Vercel links              ‚ïë
  # ‚ïë  uat ‚Üí main: creates PR with UAT Vercel links              ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

  # ‚îÄ‚îÄ Promotion: test ‚Üí uat (creates PR for manual approval) ‚îÄ‚îÄ‚îÄ‚îÄ
  create-pr-to-uat:
    name: "Create PR ‚Üí UAT"
    needs: [bayanihub-web, damayan-web, hopecard-web, version-test, deploy-test-bayanihub, deploy-test-damayan, deploy-test-hopecard]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && github.event_name == 'push' &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped') &&
      needs.version-test.result == 'success' &&
      (needs.deploy-test-bayanihub.result == 'success' || needs.deploy-test-bayanihub.result == 'skipped') &&
      (needs.deploy-test-damayan.result == 'success' || needs.deploy-test-damayan.result == 'skipped') &&
      (needs.deploy-test-hopecard.result == 'success' || needs.deploy-test-hopecard.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Validate PAT for PR creation
        env:
          GH_PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}
        run: |
          if [ -z "${GH_PR_TOKEN}" ]; then
            echo "‚ùå Missing PAT secret for PR creation."
            echo "Add GH_PR_TOKEN as an organization or repository secret."
            echo "Required repository permissions: Pull requests (Read and write), Contents (Read-only or Read and write)."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PR_TOKEN }}

      - name: Create PR from test ‚Üí uat
        env:
          GH_TOKEN: ${{ secrets.GH_PR_TOKEN }}
        run: |
          git fetch origin test uat --no-tags
          COMMITS_AHEAD=$(git rev-list --count origin/uat..origin/test || echo 0)
          if [ "${COMMITS_AHEAD}" -eq 0 ]; then
            echo "‚ÑπÔ∏è No commits between test and uat. Skipping PR creation."
            exit 0
          fi

          EXISTING_PR=$(gh pr list --base uat --head test --state open --json number --jq '.[0].number' 2>/dev/null || true)

          BAYANIHUB_URL="${{ needs.deploy-test-bayanihub.outputs.deployment_url }}"
          DAMAYAN_URL="${{ needs.deploy-test-damayan.outputs.deployment_url }}"
          HOPECARD_URL="${{ needs.deploy-test-hopecard.outputs.deployment_url }}"
          VERSION_TAG="${{ needs.version-test.outputs.version_tag }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          PR_BODY=$(cat <<ENDOFBODY
          ## üöÄ Promote TEST ‚Üí UAT

          This PR was **automatically created** after all CI checks and TEST deployments passed on the \`test\` branch.

          ### üìã Pre-merge Checklist
          - [ ] Verified ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }} on TEST
          - [ ] Verified ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }} on TEST
          - [ ] Verified ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }} on TEST
          - [ ] Ready for UAT validation

          ### üîó Vercel TEST Deployment Links
          | System | TEST Preview Link |
          |--------|-------------------|
          | ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }} | ${BAYANIHUB_URL:-Not deployed (no changes)} |
          | ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }} | ${DAMAYAN_URL:-Not deployed (no changes)} |
          | ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }} | ${HOPECARD_URL:-Not deployed (no changes)} |

          ### üîç Details
          - **Source branch:** test
          - **Target branch:** uat
          - **Version tag:** \`${VERSION_TAG}\`
          - **Commit:** \`${SHORT_SHA}\`
          - **Triggered at:** ${TIMESTAMP}
          - **Pipeline run:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *Merge this PR to trigger UAT deployment.*
          ENDOFBODY
          )

          if [ -n "$EXISTING_PR" ]; then
            gh pr edit "$EXISTING_PR" --body "$PR_BODY"
            echo "‚úÖ Updated PR #$EXISTING_PR: test ‚Üí uat"
            exit 0
          fi

          gh pr create \
            --base uat \
            --head test \
            --title "üöÄ Release: Promote TEST ‚Üí UAT (${SHORT_SHA})" \
            --body "$PR_BODY"

          echo "‚úÖ Created PR: test ‚Üí uat"

  # ‚îÄ‚îÄ Promotion: uat ‚Üí main (creates PR for manual approval) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  create-pr-to-main:
    name: "Create PR ‚Üí Main"
    needs: [bayanihub-web, damayan-web, hopecard-web, deploy-uat-bayanihub, deploy-uat-damayan, deploy-uat-hopecard]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' && github.event_name == 'push' &&
      (needs.bayanihub-web.result == 'success' || needs.bayanihub-web.result == 'skipped') &&
      (needs.damayan-web.result == 'success' || needs.damayan-web.result == 'skipped') &&
      (needs.hopecard-web.result == 'success' || needs.hopecard-web.result == 'skipped') &&
      (needs.deploy-uat-bayanihub.result == 'success' || needs.deploy-uat-bayanihub.result == 'skipped') &&
      (needs.deploy-uat-damayan.result == 'success' || needs.deploy-uat-damayan.result == 'skipped') &&
      (needs.deploy-uat-hopecard.result == 'success' || needs.deploy-uat-hopecard.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Validate PAT for PR creation
        env:
          GH_PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}
        run: |
          if [ -z "${GH_PR_TOKEN}" ]; then
            echo "‚ùå Missing PAT secret for PR creation."
            echo "Add GH_PR_TOKEN as an organization or repository secret."
            echo "Required repository permissions: Pull requests (Read and write), Contents (Read-only or Read and write)."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PR_TOKEN }}

      - name: Create PR from uat ‚Üí main
        env:
          GH_TOKEN: ${{ secrets.GH_PR_TOKEN }}
        run: |
          git fetch origin uat main --no-tags
          COMMITS_AHEAD=$(git rev-list --count origin/main..origin/uat || echo 0)
          if [ "${COMMITS_AHEAD}" -eq 0 ]; then
            echo "‚ÑπÔ∏è No commits between uat and main. Skipping PR creation."
            exit 0
          fi

          # Check if an open PR from uat ‚Üí main already exists
          EXISTING_PR=$(gh pr list --base main --head uat --state open --json number --jq '.[0].number' 2>/dev/null || true)

          if [ -n "$EXISTING_PR" ]; then
            echo "‚úÖ PR #$EXISTING_PR already exists (uat ‚Üí main). Updating with latest deploy URLs..."

            # Build updated body with real Vercel URLs
            BAYANIHUB_URL="${{ needs.deploy-uat-bayanihub.outputs.deployment_url }}"
            DAMAYAN_URL="${{ needs.deploy-uat-damayan.outputs.deployment_url }}"
            HOPECARD_URL="${{ needs.deploy-uat-hopecard.outputs.deployment_url }}"
            COMMIT_SHA="${{ github.sha }}"
            SHORT_SHA="${COMMIT_SHA:0:7}"
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

            UPDATE_BODY=$(cat <<ENDOFBODY
          ## üöÄ Promote UAT ‚Üí Production

          This PR was **automatically created** after all CI checks and UAT deployments passed on the \`uat\` branch.

          ### üìã Pre-merge Checklist
          - [ ] Verified ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }} on UAT
          - [ ] Verified ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }} on UAT
          - [ ] Verified ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }} on UAT
          - [ ] All acceptance criteria met

          ### üîó Vercel UAT Deployment Links
          | System | UAT Preview Link |
          |--------|------------------|
          | ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }} | ${BAYANIHUB_URL:-Not deployed (no changes)} |
          | ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }} | ${DAMAYAN_URL:-Not deployed (no changes)} |
          | ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }} | ${HOPECARD_URL:-Not deployed (no changes)} |

          ### üîç Details
          - **Source branch:** uat
          - **Target branch:** main
          - **Latest commit:** \`${SHORT_SHA}\`
          - **Updated at:** ${TIMESTAMP}
          - **Pipeline run:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *Merge this PR to deploy to production. A production readiness gate will run automatically.*
          ENDOFBODY
            )

            gh pr edit "$EXISTING_PR" --body "$UPDATE_BODY"
            echo "‚úÖ Updated PR #$EXISTING_PR with latest deployment URLs"
            exit 0
          fi

          # Collect deployment URLs from UAT Vercel deploys
          BAYANIHUB_URL="${{ needs.deploy-uat-bayanihub.outputs.deployment_url }}"
          DAMAYAN_URL="${{ needs.deploy-uat-damayan.outputs.deployment_url }}"
          HOPECARD_URL="${{ needs.deploy-uat-hopecard.outputs.deployment_url }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          PR_BODY=$(cat <<ENDOFBODY
          ## üöÄ Promote UAT ‚Üí Production

          This PR was **automatically created** after all CI checks and UAT deployments passed on the \`uat\` branch.

          ### üìã Pre-merge Checklist
          - [ ] Verified ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }} on UAT
          - [ ] Verified ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }} on UAT
          - [ ] Verified ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }} on UAT
          - [ ] All acceptance criteria met

          ### üîó Vercel UAT Deployment Links
          | System | UAT Preview Link |
          |--------|------------------|
          | ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }} | ${BAYANIHUB_URL:-Not deployed (no changes)} |
          | ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }} | ${DAMAYAN_URL:-Not deployed (no changes)} |
          | ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }} | ${HOPECARD_URL:-Not deployed (no changes)} |

          ### üîç Details
          - **Source branch:** uat
          - **Target branch:** main
          - **Commit:** \`${SHORT_SHA}\`
          - **Triggered at:** ${TIMESTAMP}
          - **Pipeline run:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *Merge this PR to deploy to production. A production readiness gate will run automatically.*
          ENDOFBODY
          )

          gh pr create \
            --base main \
            --head uat \
            --title "üöÄ Release: Promote UAT ‚Üí Production (${SHORT_SHA})" \
            --body "$PR_BODY"

          echo "‚úÖ Created PR: uat ‚Üí main"

  # ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  # ‚ïë  STAGE 4 ‚Äî Pipeline Summary & Notifications                ‚ïë
  # ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  pipeline-summary:
    name: "Pipeline Summary"
    needs: [bayanihub-web, damayan-web, hopecard-web]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline Results
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë          MASTER PIPELINE SUMMARY                     ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë Repository: ${{ github.repository }}"
          echo "‚ïë Branch:     ${{ github.ref_name }}"
          echo "‚ïë Commit:     ${{ github.sha }}"
          echo "‚ïë Actor:      ${{ github.actor }}"
          echo "‚ïë Timestamp:  $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë ${{ vars.FE_MULTI_APP1_NAME != '' && vars.FE_MULTI_APP1_NAME || 'system-1' }}:   ${{ needs.bayanihub-web.result }}"
          echo "‚ïë ${{ vars.FE_MULTI_APP2_NAME != '' && vars.FE_MULTI_APP2_NAME || 'system-2' }}:     ${{ needs.damayan-web.result }}"
          echo "‚ïë ${{ vars.FE_MULTI_APP3_NAME != '' && vars.FE_MULTI_APP3_NAME || 'system-3' }}:    ${{ needs.hopecard-web.result }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

          FAILED=false
          if [[ "${{ needs.bayanihub-web.result }}" == "failure" ]]; then FAILED=true; fi
          if [[ "${{ needs.damayan-web.result }}" == "failure" ]]; then FAILED=true; fi
          if [[ "${{ needs.hopecard-web.result }}" == "failure" ]]; then FAILED=true; fi

          if [ "$FAILED" = "true" ]; then
            echo "‚ùå One or more pipelines failed!"
            exit 1
          fi
          echo "‚úÖ All pipelines completed successfully!"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "üîî Pipeline failure notification"
          echo "Failed pipelines detected for commit ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add Slack/Discord/Email notification here
          # curl -X POST "$SLACK_WEBHOOK" -d '{"text": "Pipeline failed..."}'

  auto-revert-on-failure:
    name: "Auto Revert Failed Commit"
    needs:
      - bayanihub-web
      - damayan-web
      - hopecard-web
      - sonarcloud
      - version-test
      - deploy-test-bayanihub
      - deploy-test-damayan
      - deploy-test-hopecard
      - deploy-uat-bayanihub
      - deploy-uat-damayan
      - deploy-uat-hopecard
      - create-pr-to-uat
      - create-pr-to-main
    if: >-
      always() &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/test' || github.ref == 'refs/heads/uat') &&
      github.actor != 'github-actions[bot]' &&
      contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PR_TOKEN != '' && secrets.GH_PR_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Revert failed commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TARGET_SHA="${{ github.sha }}"
          PARENT_COUNT=$(git rev-list --parents -n 1 "${TARGET_SHA}" | awk '{print NF-1}')

          if [ "${PARENT_COUNT}" -gt 1 ]; then
            echo "‚ÑπÔ∏è Reverting merge commit ${TARGET_SHA} with mainline parent 1"
            git revert -m 1 --no-edit "${TARGET_SHA}"
          else
            git revert --no-edit "${TARGET_SHA}"
          fi

          REVERT_MSG=$(git log -1 --pretty=%B)
          git commit --amend -m "${REVERT_MSG}"$'\n\n[skip ci]'
          git push origin HEAD:${{ github.ref_name }}

