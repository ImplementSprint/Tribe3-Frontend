# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  REUSABLE: Vercel Deployment                                   â•‘
# â•‘  Handles UAT (preview) and Production deploys                 â•‘
# â•‘  Monorepo: each sub-project has its own VERCEL_PROJECT_ID     â•‘
# â•‘                                                                â•‘
# â•‘  Required repo secrets (per sub-project):                     â•‘
# â•‘    VERCEL_TOKEN              â€” shared Vercel API token         â•‘
# â•‘    VERCEL_ORG_ID             â€” shared Vercel Org/Team ID      â•‘
# â•‘    VERCEL_PROJECT_ID_BAYANIHUB_WEB                            â•‘
# â•‘    VERCEL_PROJECT_ID_DAMAYAN_WEB                              â•‘
# â•‘    VERCEL_PROJECT_ID_HOPECARD_WEB                             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "Reusable: Vercel Deploy"

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
        description: "Project directory (e.g. BayaniHub-Web)"
      environment:
        required: false
        type: string
        default: "preview"
        description: "Deployment environment (preview|production)"
    secrets:
      VERCEL_TOKEN:
        required: true
      VERCEL_ORG_ID:
        required: true
      VERCEL_PROJECT_ID:
        required: true
    outputs:
      deployment_url:
        description: "Vercel deployment URL"
        value: ${{ jobs.vercel-deploy.outputs.url }}
      deployment_id:
        description: "Vercel deployment ID"
        value: ${{ jobs.vercel-deploy.outputs.id }}

jobs:
  vercel-deploy:
    name: "Deploy to Vercel (${{ inputs.environment }})"
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      id: ${{ steps.deploy.outputs.id }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Project Directory
        run: |
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found in ./${{ inputs.working-directory }}"
            echo "This usually means Vercel Root Directory is misconfigured for this project."
            echo "Set Vercel Root Directory to '.' for this linked sub-project context."
            exit 1
          fi
        working-directory: ./${{ inputs.working-directory }}

      - name: Install Vercel CLI
        run: npm install -g vercel@50.22.1

      - name: Pull and Build with Vercel (adaptive context)
        id: prepare
        run: |
          set -uo pipefail

          run_pull_build() {
            local dir="$1"
            echo "ðŸ”Ž Trying Vercel pull/build in: $dir"

            pushd "$dir" > /dev/null

            vercel pull --yes --environment=${{ inputs.environment }} --token=${{ secrets.VERCEL_TOKEN }}
            local pull_status=$?
            if [ $pull_status -ne 0 ]; then
              echo "âŒ vercel pull failed in $dir"
              popd > /dev/null
              return 1
            fi

            if [ "${{ inputs.environment }}" = "production" ]; then
              vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
            else
              vercel build --token=${{ secrets.VERCEL_TOKEN }}
            fi
            local build_status=$?
            if [ $build_status -ne 0 ]; then
              echo "âŒ vercel build failed in $dir"
              popd > /dev/null
              return 1
            fi

            if [ ! -d ".vercel/output" ]; then
              echo "âŒ .vercel/output not found in $dir"
              popd > /dev/null
              return 1
            fi

            popd > /dev/null
            return 0
          }

          if run_pull_build "./${{ inputs.working-directory }}"; then
            echo "deploy_dir=./${{ inputs.working-directory }}" >> "$GITHUB_OUTPUT"
            echo "âœ… Using deploy directory: ./${{ inputs.working-directory }}"
          elif run_pull_build "."; then
            echo "deploy_dir=." >> "$GITHUB_OUTPUT"
            echo "âœ… Using deploy directory: ."
          else
            echo "âŒ Vercel pull/build failed in both contexts."
            echo "Check VERCEL_PROJECT_ID mapping and Root Directory in Vercel project settings."
            exit 1
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          else
            URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deployed to: $URL"
        working-directory: ${{ steps.prepare.outputs.deploy_dir }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Comment Deployment URL on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const body = `## ðŸš€ Vercel Preview Deployment\n\n` +
              `**Project:** \`${{ inputs.working-directory }}\`\n` +
              `**Environment:** \`${{ inputs.environment }}\`\n` +
              `**URL:** ${url}\n` +
              `**Commit:** \`${{ github.sha }}\``;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
